generator client {
  provider   = "prisma-client"
  engineType = "client"
  output     = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum AccountType {
  CHECKING
  SAVINGS
}

enum AccountStatus {
  ACTIVE
  FROZEN
  CLOSED
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum TransferStatus {
  PENDING
  COMPLETED
  FAILED
}

enum CardType {
  DEBIT
  CREDIT
}

enum CardStatus {
  ACTIVE
  BLOCKED
  EXPIRED
  CANCELLED
}

enum DepositStatus {
  PENDING
  COMPLETED
  FAILED
}

enum WithdrawalStatus {
  PENDING
  COMPLETED
  FAILED
}

enum VerificationSessionStatus {
  IN_PROGRESS
  VERIFIED
  FAILED
  EXPIRED
}

enum CustomerStatus {
  ACTIVE
  SUSPENDED
  CLOSED
}

enum EmployeeRole {
  TELLER
  ADMIN
  CALL_CENTER_AGENT
  BOT
}

model Customer {
  id          String         @id @default(uuid())
  email       String         @unique
  password    String         // bcrypt hash
  firstName   String
  lastName    String
  dateOfBirth DateTime
  phone       String         @unique
  address     String         // full address string
  zipCode     String
  status      CustomerStatus @default(ACTIVE)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  accounts             Account[]
  refreshTokens        RefreshToken[]
  verificationSessions VerificationSession[]
}

model Account {
  id            String        @id @default(uuid())
  customerId    String
  accountNumber String        @unique // 10-digit number
  type          AccountType
  currency      String        @default("USD")
  balance       Int           @default(0) // in cents
  status        AccountStatus @default(ACTIVE)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  customer     Customer      @relation(fields: [customerId], references: [id])
  transactions Transaction[]
  cards        Card[]
  deposits     Deposit[]
  withdrawals  Withdrawal[]

  transfersFrom Transfer[] @relation("TransferFrom")
  transfersTo   Transfer[] @relation("TransferTo")

  @@index([customerId])
}

model Transaction {
  id                String            @id @default(uuid())
  accountId         String
  type              TransactionType
  amount            Int               // in cents, always positive
  balanceAfter      Int               // in cents
  description       String
  reference         String            @unique @default(uuid())
  status            TransactionStatus @default(COMPLETED)
  counterpartyName  String?
  counterpartyBank  String?
  createdAt         DateTime          @default(now())

  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
  @@index([createdAt])
}

model Transfer {
  id            String         @id @default(uuid())
  fromAccountId String
  toAccountId   String
  amount        Int            // in cents
  description   String?
  status        TransferStatus @default(PENDING)
  reference     String         @unique @default(uuid())
  createdAt     DateTime       @default(now())

  fromAccount Account @relation("TransferFrom", fields: [fromAccountId], references: [id])
  toAccount   Account @relation("TransferTo", fields: [toAccountId], references: [id])

  @@index([fromAccountId])
  @@index([toAccountId])
}

model Card {
  id           String     @id @default(uuid())
  accountId    String
  cardNumber   String     @unique // stored encrypted/hashed
  maskedNumber String     // e.g. "****-****-****-1234"
  expiryDate   String     // MM/YY format
  cvv          String     // stored hashed, never returned after creation
  type         CardType
  status       CardStatus @default(ACTIVE)
  dailyLimit   Int        @default(500000) // in cents ($5,000)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
}

model Deposit {
  id        String        @id @default(uuid())
  accountId String
  amount    Int           // in cents
  reference String        @unique @default(uuid())
  source    String        // e.g. "CASH", "CHECK", "WIRE"
  status    DepositStatus @default(COMPLETED)
  createdAt DateTime      @default(now())

  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
}

model Withdrawal {
  id        String           @id @default(uuid())
  accountId String
  amount    Int              // in cents
  reference String           @unique @default(uuid())
  channel   String           // e.g. "ATM", "TELLER", "ONLINE"
  status    WithdrawalStatus @default(COMPLETED)
  createdAt DateTime         @default(now())

  account Account @relation(fields: [accountId], references: [id])

  @@index([accountId])
}

model VerificationSession {
  id             String                    @id @default(uuid())
  phoneNumber    String
  customerId     String?
  status         VerificationSessionStatus @default(IN_PROGRESS)
  confidence     Float                     @default(0) // 0.0 to 1.0
  questionsAsked Json                      @default("[]") // array of question IDs asked
  correctAnswers Int                       @default(0)
  createdAt      DateTime                  @default(now())
  expiresAt      DateTime                  // createdAt + 10 minutes

  customer Customer? @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

model RefreshToken {
  id         String   @id @default(uuid())
  customerId String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])

  @@index([customerId])
}

model Employee {
  id         String       @id @default(uuid())
  employeeId String       @unique // e.g. "EMP-001"
  email      String       @unique
  password   String?      // bcrypt hash (null for BOT employees)
  firstName  String
  lastName   String
  role       EmployeeRole
  active     Boolean      @default(true)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  refreshTokens EmployeeRefreshToken[]
  auditLogs     AuditLog[]
  apiTokens     ApiToken[]
}

model ApiToken {
  id         String    @id @default(uuid())
  employeeId String
  token      String    @unique // SHA-256 hash of the raw token
  prefix     String    // first 8 chars for display (e.g., "botk_abc1")
  name       String    @default("Default")
  active     Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
}

model EmployeeRefreshToken {
  id         String   @id @default(uuid())
  employeeId String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
}

model AuditLog {
  id         String   @id @default(uuid())
  employeeId String
  action     String   // e.g. "CUSTOMER_CREATED", "ACCOUNT_FROZEN"
  entityType String   // e.g. "Customer", "Account", "Card"
  entityId   String
  details    Json     // action-specific details
  createdAt  DateTime @default(now())

  employee Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model IdempotencyRecord {
  key       String   @id
  route     String   // method + path
  body      String   // hashed request body
  response  Json     // stored response
  status    Int      // HTTP status code
  createdAt DateTime @default(now())

  @@index([createdAt])
}
